# ---------------------------
# Basic Kamailio Config
# ---------------------------

debug=3
log_stderr=yes

# SIP port
listen=udp:0.0.0.0:5060

# MySQL credentials
#!define DB_ENGINE MYSQL
#!define DB_HOST mysql
#!define DB_PORT 3306
#!define DB_USER voip
#!define DB_PASS test
#!define DB_NAME voipdb

# Modules
loadmodule "db_mysql.so"
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "auth.so"
loadmodule "auth_db.so"
loadmodule "dispatcher.so"
loadmodule "textops.so"
loadmodule "siptrace.so"

# Authentication
modparam("auth_db", "calculate_ha1", yes)

# Core routing
route {
    if (!mf_process_maxfwd_header()) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }

    if (msg:method == "REGISTER") {
        save("location");
        exit;
    }

    if (!lookup("location")) {
        sl_send_reply("404","Not Found");
        exit;
    }

    route(OUTBOUND);
}

route[OUTBOUND] {
    if (!t_relay()) {
        sl_send_reply("503","Service Unavailable");
    }
}
